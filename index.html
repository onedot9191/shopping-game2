<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë˜‘ë˜‘í•œ ì‡¼í•‘, ì•Œëœ°ì‚´ëœ° í¸ì˜ì  ì²´í—˜!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nanum Gothic', sans-serif;
            background-color: #f0fdf4; /* Light green background */
        }
        .game-container {
            max-width: 900px; 
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 40px); 
        }
        .screen-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .header-image {
            width: 100%;
            max-height: 200px; 
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer; 
        }
        .button:hover:not([disabled]) { 
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .button:active:not([disabled]) { 
            transform: translateY(0px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button[disabled] { 
            background-color: #d1d5db; 
            color: #9ca3af; 
            cursor: not-allowed;
            box-shadow: none;
        }
        .item-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
            background-color: #fff;
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
        }
        .item-card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
            transform: translateY(-4px);
        }
        .item-emoji {
            font-size: 3rem; 
            margin-bottom: 8px;
        }
        .item-details {
            flex-grow: 1; 
            margin-bottom: 8px;
        }
        .cart-item {
            border-bottom: 1px solid #f1f5f9;
            padding: 10px 0; 
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        
        .feedback-card-base { 
            background-color: #f0fdf4; 
            border-left-width: 4px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem; 
            text-align: left;
        }
        .success-feedback { border-color: #22c55e; } 
        .warning-feedback { border-color: #f97316; } 
        .error-feedback { border-color: #ef4444; }   

        .reflection-page-container { 
            margin-top: 1rem; 
            padding: 1.5rem;
            background-color: #dcfce7; 
            border-radius: 12px;
            border: 2px dashed #4ade80; 
            text-align: center; 
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
        }
        .reflection-page-container h3 { /* ì œëª© ìŠ¤íƒ€ì¼ */
            color: #15803d; 
            margin-bottom: 1rem; 
            font-size: 1.75rem; /* Slightly larger title */
        }
        .reflection-question-block { /* ì§ˆë¬¸ ì˜ì—­ì„ í’ì„ ê»Œ/ë§í’ì„ ì²˜ëŸ¼ ë³´ì´ê²Œ */
            background-color: #f0fdf4; 
            margin-bottom: 1.5rem; 
            padding: 1.5rem 2rem; /* íŒ¨ë”© ì¡°ì • */
            border-radius: 25px; /* ë” ë‘¥ê¸€ê²Œ */
            border: 3px solid #86efac; /* ë°ì€ ë…¹ìƒ‰ í…Œë‘ë¦¬ */
            text-align: left;
            position: relative; /* ìºë¦­í„° ì•„ì´ì½˜ ë°°ì¹˜ë¥¼ ìœ„í•´ */
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .reflection-question-block::before { /* ë§í’ì„  ê¼¬ë¦¬ (ì„ íƒ ì‚¬í•­) */
            content: "";
            position: absolute;
            bottom: -15px; /* ê¼¬ë¦¬ ìœ„ì¹˜ */
            left: 30px;
            border-width: 15px 15px 0;
            border-style: solid;
            border-color: #86efac transparent transparent transparent;
        }

        .question-content-wrapper { /* ì§ˆë¬¸ í…ìŠ¤íŠ¸ì™€ ìºë¦­í„° ì•„ì´ì½˜ ë¬¶ìŒ */
            display: flex;
            align-items: flex-start; /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ìƒë‹¨ ì •ë ¬ */
            gap: 0.75rem; /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ì‚¬ì´ ê°„ê²© */
        }
        .question-character-icon {
            font-size: 1.8rem; /* ìºë¦­í„° ì•„ì´ì½˜ í¬ê¸° */
            color: #16a34a; /* ìºë¦­í„° ì•„ì´ì½˜ ìƒ‰ìƒ */
            padding-top: 0.1rem; /* ì•„ì´ì½˜ ìƒë‹¨ ì •ë ¬ ë¯¸ì„¸ì¡°ì • */
        }

        .reflection-question-block p { 
            font-size: 1.1rem; 
            font-weight: 600; 
            color: #166534; 
            margin-bottom: 0.75rem;
            flex-grow: 1; /* ì§ˆë¬¸ í…ìŠ¤íŠ¸ê°€ ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
        }
        .reflection-page-container textarea {
            width: 100%;
            min-height: 100px; 
            padding: 0.75rem; 
            border: 1px solid #d1d5db; 
            border-radius: 6px;
            font-size: 1rem; 
            resize: vertical; 
        }
        .navigation-buttons {
            display: flex;
            justify-content: space-between; 
            margin-top: 1.5rem;
        }
         .navigation-buttons .button, .single-action-button .button, #reflection-actions .button { 
            min-width: 120px;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        #reflection-actions { 
            display: flex;
            gap: 1rem; 
            justify-content: center; 
            flex-wrap: wrap; 
        }


        .saved-answers-container {
             margin-top: 2rem;
            padding: 1.5rem;
            background-color: #eff6ff; 
            border-radius: 12px;
            border: 2px solid #60a5fa; 
        }
         .saved-answers-container h3 {
            color: #1d4ed8; 
            text-align: center;
            margin-bottom: 1rem;
        }
        .saved-answers-container .answer-block {
            background-color: #dbeafe;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 3px solid #3b82f6;
        }
        .saved-answers-container .answer-block p {
            margin-bottom: 0.5rem;
        }

        .budget-warning-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6); 
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        .budget-warning-box {
            background-color: #fef2f2; 
            border: 4px solid #ef4444; 
            color: #b91c1c; 
            padding: 2rem; 
            border-radius: 1rem; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
            max-width: 450px; 
            width: 90%;
        }
         .budget-warning-box p {
            font-size: 1.25rem; 
            font-weight: 700; 
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        .budget-warning-box .button { 
            background-color: #ef4444;
            color: white;
        }
         .budget-warning-box .button:hover {
            background-color: #dc2626;
        }

        /* Animations */
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop-in {
            animation: popIn 0.4s ease-out forwards;
        }

        @keyframes popOut {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.5); opacity: 0; }
        }
        .animate-pop-out {
            animation: popOut 0.3s ease-in forwards;
        }

        @keyframes buttonPress {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        .animate-button-press {
            animation: buttonPress 0.2s ease-out;
        }
        
        @keyframes budgetUpdate {
            0% { transform: scale(1); color: #15803d; }
            50% { transform: scale(1.15); color: #f59e0b; }
            100% { transform: scale(1); color: #15803d; }
        }
        .animate-budget-update {
            animation: budgetUpdate 0.5s ease-in-out;
        }

        /* Praise Animation Styles */
        .praise-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .praise-overlay.visible {
            opacity: 1;
        }
        .praise-box {
            background-color: #ecfdf5; /* Tailwind green-50 */
            color: #065f46; /* Tailwind green-800 */
            padding: 2rem 3rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            text-align: center;
            transform: scale(0.7);
            opacity: 0;
            animation: praisePopIn 0.5s 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .praise-box .emoji {
            font-size: 3rem;
            margin-bottom: 1rem;
            animation: emojiDance 1s infinite alternate ease-in-out;
        }
        @keyframes praisePopIn {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        @keyframes emojiDance {
            from { transform: rotate(-10deg) scale(1); }
            to { transform: rotate(10deg) scale(1.1); }
        }


        ::-webkit-scrollbar {
            width: 10px; 
        }
        ::-webkit-scrollbar-track {
            background: #dcfce7; 
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4ade80; 
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #22c55e; 
        }

        @media (min-width: 768px) {
            .item-emoji {
                font-size: 3.5rem; 
            }
             #items-container {
                grid-template-columns: repeat(3, minmax(0, 1fr)); 
            }
        }

        @media (max-width: 767px) {
            .game-container {
                margin: 10px;
                padding: 15px;
                min-height: calc(100vh - 20px);
            }
            #items-container {
                 grid-template-columns: repeat(2, minmax(0, 1fr)); 
            }
            .item-card {
                padding: 12px;
            }
            .item-emoji {
                font-size: 2.5rem; 
            }
            .text-4xl { font-size: 1.875rem; } 
            .text-3xl { font-size: 1.5rem;   }
            .text-2xl { font-size: 1.25rem;  }
            .text-xl { font-size: 1.125rem; }
            .text-lg { font-size: 1rem;     }

            .flex-col.md\:flex-row { 
                flex-direction: column;
            }
            .w-full.md\:w-3\/5, .w-full.md\:w-2\/5 { 
                width: 100%;
            }
            .reflection-page-container, .saved-answers-container {
                padding: 1rem;
            }
            .reflection-question-block {
                padding: 1rem;
            }
            .reflection-page-container textarea {
                font-size: 0.9rem;
                min-height: 80px;
            }
             .navigation-buttons .button, .single-action-button .button, #reflection-actions .button {
                min-width: 100px; 
                font-size: 0.875rem; 
            }
            .budget-warning-box {
                padding: 1.5rem;
            }
            .budget-warning-box p {
                font-size: 1.1rem;
            }
             .praise-box {
                padding: 1.5rem 2rem;
            }
            .praise-box .emoji {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Start Screen -->
        <div id="start-screen" class="screen-content text-center">
            <div>
                <img src="https://placehold.co/800x200/bef264/4d7c0f?text=Store!%20Go%20Shopping!" alt="í¸ì˜ì  ì‡¼í•‘ ê·¸ë¦¼" class="header-image" onerror="this.onerror=null;this.src='https://placehold.co/800x200/e0e0e0/555555?text=Store+Image+Error';">
                <h1 class="text-4xl font-bold text-lime-600 mb-4">ë˜‘ë˜‘í•œ ì‡¼í•‘, ì•Œëœ°ì‚´ëœ° í¸ì˜ì  ì²´í—˜! ğŸª</h1>
                <p class="text-lg text-gray-700 mb-6">
                    í•™êµ ëë‚˜ê³  ì¶œì¶œí•œ ë°°ë¥¼ ì±„ìš°ëŸ¬ í¸ì˜ì ì— ì™”ì–´ìš”! ğŸ˜‹<br>
                    ë§›ìˆëŠ” ê°„ì‹ê³¼ í•„ìš”í•œ ë¬¼ê±´ë“¤ì´ ê°€ë“í•˜ë„¤ìš”.<br>
                    ì˜¤ëŠ˜ ì“¸ ìˆ˜ ìˆëŠ” ìš©ëˆì€ <strong class="text-xl text-red-500 font-semibold">5,000ì›</strong>ì´ì—ìš”.<br>
                    ì–´ë–¤ ê²ƒì„ ê³¨ë¼ì•¼ ê°€ì¥ ë°°ë¶€ë¥´ê³  ê¸°ë¶„ ì¢‹ì„ê¹Œìš”? ì˜ ìƒê°í•´ì„œ ê³¨ë¼ë´ìš”!
                </p>
            </div>
            <button id="start-button" class="button bg-lime-500 hover:bg-lime-600 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg mt-auto">
                ì¢‹ì•„, ì‡¼í•‘ ì‹œì‘! ğŸ›’
            </button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden">
            <div class="flex flex-col md:flex-row gap-6">
                <div class="w-full md:w-3/5">
                    <h2 class="text-3xl font-semibold text-center text-sky-500 mb-6">ğŸª í¸ì˜ì  ìƒí’ˆ ğŸª</h2>
                    <div id="items-container" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                </div>
                <div class="w-full md:w-2/5 bg-yellow-100 p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-center text-yellow-700 mb-4">ğŸ›’ ë‚˜ì˜ ì¥ë°”êµ¬ë‹ˆ ğŸ›’</h2>
                    <div id="cart-items" class="mb-4 min-h-[150px] max-h-[300px] md:max-h-[400px] overflow-y-auto bg-white p-3 rounded-lg">
                        <p id="empty-cart-message" class="text-gray-500 text-center">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆì–´ìš”.</p>
                    </div>
                    <div class="text-lg font-semibold mb-2">
                        í•©ê³„: <span id="total-cost" class="text-orange-600">0ì›</span>
                    </div>
                    <div class="text-lg font-semibold mb-6">
                        ë‚¨ì€ ëˆ: <span id="remaining-budget" class="text-lime-700">5,000ì›</span>
                    </div>
                    <button id="checkout-button" class="button w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg">
                        ê³„ì‚°ëŒ€ë¡œ ê°€ê¸°! ğŸ’°
                    </button>
                </div>
            </div>
        </div>

        <!-- Feedback Screen -->
        <div id="feedback-screen" class="hidden screen-content text-center">
            <div>
                <h2 id="feedback-title" class="text-4xl font-bold mb-6">ì•Œëœ°ì‚´ëœ° ì‡¼í•‘ ê²°ê³¼!</h2>
                <div id="feedback-message-card" class="feedback-card-base text-lg">
                    <!-- Feedback message will be displayed here -->
                </div>
                 <div id="purchased-items-summary" class="my-6">
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">ë‚´ê°€ ê³ ë¥¸ ë¬¼ê±´ë“¤:</h3>
                    <ul id="final-cart-list" class="list-disc list-inside text-left max-w-md mx-auto text-gray-600"></ul>
                </div>
            </div>
            <div class="mt-auto space-y-4">
                <button id="go-to-reflection-button" class="button bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg w-full">
                    ë‚˜ì˜ ì‡¼í•‘ ëŒì•„ë³´ê¸° ê³°ê³°ì´ ìƒê°í•´ìš”! ğŸ¤”
                </button>
                 <button id="play-again-button-feedback" class="button bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg w-full">
                    ë‹¤ì‹œ ì‡¼í•‘í•´ë³¼ê¹Œ? ğŸ›ï¸
                </button>
            </div>
        </div>
        
        <!-- Reflection Screen (One question per page) -->
        <div id="reflection-screen" class="hidden">
            <div class="reflection-page-container">
                <div> 
                    <h3 id="reflection-page-title" class="text-2xl font-bold">ë‚˜ì˜ ì‡¼í•‘, ê³°ê³°ì´ ìƒê°í•´ ë³´ê¸° ğŸ§</h3>
                    <div id="reflection-question-area" class="reflection-question-block">
                        <div class="question-content-wrapper">
                            <span class="question-character-icon">ğŸ¤”</span>
                            <p id="current-question-text"></p>
                        </div>
                        <textarea id="current-answer-textarea" placeholder="ì—¬ê¸°ì— ë‚˜ì˜ ìƒê°ì„ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”..."></textarea>
                    </div>
                </div>
                <div>
                    <div id="reflection-navigation" class="navigation-buttons">
                        <button id="prev-question-button" class="button bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">ì´ì „ ì§ˆë¬¸</button>
                        <button id="next-question-button" class="button bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-lg">ë‹¤ìŒ ì§ˆë¬¸</button>
                    </div>
                     <div id="reflection-actions" class="mt-6 text-center space-y-2"> 
                    </div>
                </div>
            </div>
        </div>


        <!-- Saved Answers Screen -->
        <div id="saved-answers-screen" class="hidden screen-content">
            <div class="saved-answers-container text-left flex-grow">
                <h3 class="text-2xl font-bold">ë‚´ê°€ ê¸°ë¡í•œ ìƒê°ë“¤ ğŸ’¡</h3>
                <div id="displayed-answers" class="mt-4 space-y-4">
                    <p class="text-gray-600">ì•„ì§ ì €ì¥ëœ ìƒê°ì´ ì—†ì–´ìš”. ì‡¼í•‘ì„ ë§ˆì¹˜ê³  ìƒê°ì„ ê¸°ë¡í•´ë³´ì„¸ìš”!</p>
                </div>
            </div>
            <button id="go-to-start-from-saved" class="button bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg mt-auto w-full">
                ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸° ğŸ 
            </button>
        </div>

        <!-- Praise Animation Container (Initially Hidden) -->
        <div id="praise-animation-overlay" class="praise-overlay hidden">
            <div class="praise-box">
                <div class="emoji">ğŸ‰</div>
                <p id="praise-text" class="text-xl font-semibold"></p>
            </div>
        </div>

    </div>

    <script>
        const initialBudget = 5000; 
        let currentBudget = initialBudget;
        let cart = [];
        let items = [ 
            { id: 1, name: "ğŸ™ ë§›ìˆëŠ” ì‚¼ê°ê¹€ë°¥", price: 1300, emoji: 'ğŸ™' },
            { id: 2, name: "ğŸœ ì‘ì€ ì»µë¼ë©´", price: 1000, emoji: 'ğŸœ' },
            { id: 3, name: "ğŸ« ì´ˆì½”ë°”", price: 900, emoji: 'ğŸ«' },
            { id: 4, name: "ğŸ¥¤ ê³¼ì¼ë§› ìŒë£Œìˆ˜", price: 1200, emoji: 'ğŸ¥¤' },
            { id: 5, name: "ğŸ¦ ë§‰ëŒ€ ì•„ì´ìŠ¤í¬ë¦¼", price: 800, emoji: 'ğŸ¦'},
            { id: 6, name: "ğŸ¥¨ ë¯¸ë‹ˆ ê³¼ì", price: 700, emoji: 'ğŸ¥¨'},
            { id: 7, name: "ğŸ¥› ë”¸ê¸° ìš°ìœ  (ì‘ì€ íŒ©)", price: 1000, emoji: 'ğŸ“' },
            { id: 8, name: "ğŸ’§ ì‘ì€ ìƒìˆ˜", price: 600, emoji: 'ğŸ’§' },
            { id: 9, name: "ğŸ¬ ë§‰ëŒ€ ì‚¬íƒ•", price: 500, emoji: 'ğŸ­' },
            { id: 10, name: "ğŸ¥ª ë¯¸ë‹ˆ ìƒŒë“œìœ„ì¹˜", price: 2000, emoji: 'ğŸ¥ª' },
            { id: 11, name: "âœï¸ ìºë¦­í„° ì—°í•„ (1ìë£¨)", price: 700, emoji: 'âœï¸' },
            { id: 12, name: "ğŸ—’ï¸ ì‘ì€ ë©”ëª¨ì§€", price: 1000, emoji: 'ğŸ—’ï¸' }
        ];

        const screens = {
            start: document.getElementById('start-screen'),
            game: document.getElementById('game-screen'),
            feedback: document.getElementById('feedback-screen'),
            reflection: document.getElementById('reflection-screen'),
            savedAnswers: document.getElementById('saved-answers-screen')
        };

        const startButton = document.getElementById('start-button');
        const itemsContainer = document.getElementById('items-container');
        const cartItemsContainer = document.getElementById('cart-items');
        const emptyCartMessage = document.getElementById('empty-cart-message'); 
        const totalCostEl = document.getElementById('total-cost');
        const remainingBudgetEl = document.getElementById('remaining-budget');
        const checkoutButton = document.getElementById('checkout-button');
        
        const feedbackTitleEl = document.getElementById('feedback-title');
        const feedbackMessageCardEl = document.getElementById('feedback-message-card');
        const finalCartListEl = document.getElementById('final-cart-list');
        const goToReflectionButton = document.getElementById('go-to-reflection-button');
        const playAgainButtonFeedback = document.getElementById('play-again-button-feedback');

        const reflectionPageTitleEl = document.getElementById('reflection-page-title');
        const currentQuestionTextEl = document.getElementById('current-question-text');
        const currentAnswerTextareaEl = document.getElementById('current-answer-textarea');
        const prevQuestionButton = document.getElementById('prev-question-button');
        const nextQuestionButton = document.getElementById('next-question-button');
        const reflectionActionsEl = document.getElementById('reflection-actions');
        
        const displayedAnswersEl = document.getElementById('displayed-answers');
        const goToStartFromSaved = document.getElementById('go-to-start-from-saved');
        const praiseOverlayEl = document.getElementById('praise-animation-overlay');
        const praiseTextEl = document.getElementById('praise-text');


        let currentReflectionQuestions = []; 
        let reflectionAnswers = [];
        let currentQuestionIndex = 0;

        function showScreen(screenToShow) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            screenToShow.classList.remove('hidden');
        }

        function startGame() {
            currentBudget = initialBudget;
            cart = [];
            reflectionAnswers = []; 
            currentQuestionIndex = 0; 
            remainingBudgetEl.textContent = `${initialBudget.toLocaleString()}ì›`;
            updateBudgetDisplay();
            updateCartDisplay(); 
            displayItems();
            showScreen(screens.start);
        }
        
        startButton.addEventListener('click', () => showScreen(screens.game));

        function displayItems() {
            itemsContainer.innerHTML = ''; 
            items.forEach(item => {
                const itemCard = `
                    <div class="item-card text-center">
                        <div class="item-emoji">${item.emoji}</div>
                        <div class="item-details">
                            <h3 class="text-md font-semibold text-gray-800 mb-1">${item.name}</h3>
                            <p class="text-sm text-gray-600">${item.price.toLocaleString()}ì›</p>
                        </div>
                        <button class="button add-to-cart-button bg-teal-500 hover:bg-teal-600 text-white text-sm font-semibold py-2 px-3 rounded-md w-full mt-auto" data-id="${item.id}">
                            ë‹´ê¸°
                        </button>
                    </div>
                `;
                itemsContainer.insertAdjacentHTML('beforeend', itemCard);
            });
            document.querySelectorAll('.add-to-cart-button').forEach(button => {
                button.addEventListener('click', (event) => { 
                    const cardElement = event.target.closest('.item-card'); 
                    if(cardElement) cardElement.classList.add('animate-button-press'); 
                    setTimeout(() => {
                        if(cardElement) cardElement.classList.remove('animate-button-press'); 
                    } , 200);
                    addToCart(parseInt(button.dataset.id));
                });
            });
        }

        function addToCart(itemId) {
            const itemToAdd = items.find(item => item.id === itemId);
            if (!itemToAdd) return;
            
            cart.push(itemToAdd);
            currentBudget -= itemToAdd.price;
            updateBudgetDisplay();
            updateCartDisplay(true); 
        }

        function removeFromCart(itemId) { // itemPrice is not needed here for grouped items
            // Find the first occurrence of the item in the cart by id
            const itemIndex = cart.findIndex(item => item.id === itemId);
            if (itemIndex > -1) {
                const removedItem = cart.splice(itemIndex, 1)[0];
                currentBudget += removedItem.price;
                updateBudgetDisplay();
                updateCartDisplay(false); 
            }
        }
        
        function updateBudgetDisplay() {
            totalCostEl.textContent = `${(initialBudget - currentBudget).toLocaleString()}ì›`;
            remainingBudgetEl.textContent = `${currentBudget.toLocaleString()}ì›`;
            if (currentBudget < 0) {
                remainingBudgetEl.classList.remove('text-lime-700');
                remainingBudgetEl.classList.add('text-red-600', 'font-bold');
            } else {
                remainingBudgetEl.classList.remove('text-red-600', 'font-bold');
                remainingBudgetEl.classList.add('text-lime-700');
            }
        }

        function updateCartDisplay(isAdding = false) {
            // Clear only the .cart-item elements, leaving emptyCartMessage intact
            const currentItemElements = cartItemsContainer.querySelectorAll('.cart-item');
            currentItemElements.forEach(el => el.remove());

            if (cart.length === 0) {
                emptyCartMessage.classList.remove('hidden');
            } else {
                emptyCartMessage.classList.add('hidden');

                // Group items by ID to count quantities
                const groupedCart = cart.reduce((acc, currentItem) => {
                    if (!acc[currentItem.id]) {
                        acc[currentItem.id] = { ...currentItem, quantity: 0 };
                    }
                    acc[currentItem.id].quantity++;
                    return acc;
                }, {});

                Object.values(groupedCart).forEach((itemGroup) => { 
                    const cartItemEl = document.createElement('div');
                    cartItemEl.className = 'cart-item flex justify-between items-center';
                    
                    let itemNameDisplay = `${itemGroup.emoji} ${itemGroup.name}`;
                    if (itemGroup.quantity > 1) {
                        itemNameDisplay += ` x${itemGroup.quantity}`;
                    }

                    cartItemEl.innerHTML = `
                        <span class="text-sm text-gray-700">${itemNameDisplay}</span>
                        <div class="flex items-center">
                            <span class="text-sm text-gray-600 mr-2">${(itemGroup.price * itemGroup.quantity).toLocaleString()}ì›</span>
                            <button class="remove-from-cart-button text-red-500 hover:text-red-700 text-xs font-semibold px-2 py-1" data-id="${itemGroup.id}">X</button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(cartItemEl);
        
                    // Apply pop-in animation if it was the last type of item added
                    // This logic might need refinement if you add multiple of the same item consecutively
                    const lastAddedToCart = cart[cart.length-1];
                    if (isAdding && lastAddedToCart && lastAddedToCart.id === itemGroup.id && itemGroup.quantity === cart.filter(i => i.id === itemGroup.id).length) {
                         cartItemEl.classList.add('animate-pop-in');
                    }
        
                    cartItemEl.querySelector('.remove-from-cart-button').addEventListener('click', (e) => {
                        const id = parseInt(e.target.dataset.id);
                        const itemElementToRemove = e.target.closest('.cart-item');
                        
                        if(itemElementToRemove) itemElementToRemove.classList.add('animate-pop-out');
                        
                        setTimeout(() => {
                           removeFromCart(id); // Pass only ID since we remove one instance
                        }, 300); 
                    });
                });
            }
        }


        function showBudgetWarningModal(overAmount) {
            const overlayId = 'budget-warning-overlay';
            const existingOverlay = document.getElementById(overlayId);
            if (existingOverlay) {
                document.body.removeChild(existingOverlay);
            }

            const overlay = document.createElement('div');
            overlay.id = overlayId;
            overlay.className = 'budget-warning-overlay';

            const messageBox = document.createElement('div');
            messageBox.className = 'budget-warning-box';

            const messageText = document.createElement('p');
            messageText.innerHTML = `ì•—! ìš©ëˆì´ ë¶€ì¡±í•´ìš”! ğŸ˜¥ <br> ê°€ì§„ ëˆë³´ë‹¤ ${overAmount.toLocaleString()}ì› ë” í•„ìš”í•´ìš”. <br> ì¥ë°”êµ¬ë‹ˆì—ì„œ ë¬¼ê±´ì„ ì¡°ê¸ˆ ë¹¼ì£¼ì„¸ìš”!`;

            const closeButton = document.createElement('button');
            closeButton.className = 'button mt-4 py-3 px-8 rounded-lg text-lg'; 
            closeButton.textContent = 'í™•ì¸í•˜ê³  ëŒì•„ê°€ê¸°';
            closeButton.onclick = () => {
                document.body.removeChild(overlay);
            };

            messageBox.appendChild(messageText);
            messageBox.appendChild(closeButton);
            overlay.appendChild(messageBox);
            document.body.appendChild(overlay);
        }
        
        function checkout() {
            if (currentBudget < 0) {
                showBudgetWarningModal(Math.abs(currentBudget));
                return; 
            }

            showScreen(screens.feedback);
            finalCartListEl.innerHTML = ''; 

            // Group items for final display
            const groupedCartForFinalDisplay = cart.reduce((acc, currentItem) => {
                if (!acc[currentItem.id]) {
                    acc[currentItem.id] = { ...currentItem, quantity: 0 };
                }
                acc[currentItem.id].quantity++;
                return acc;
            }, {});


            if (cart.length > 0) {
                Object.values(groupedCartForFinalDisplay).forEach(itemGroup => {
                    const listItem = document.createElement('li');
                    let itemNameDisplay = `${itemGroup.emoji} ${itemGroup.name}`;
                    if (itemGroup.quantity > 1) {
                        itemNameDisplay += ` x${itemGroup.quantity}`;
                    }
                    listItem.textContent = `${itemNameDisplay} (${(itemGroup.price * itemGroup.quantity).toLocaleString()}ì›)`;
                    finalCartListEl.appendChild(listItem);
                });

                remainingBudgetEl.classList.add('animate-budget-update');
                totalCostEl.classList.add('animate-budget-update');
                setTimeout(() => {
                    remainingBudgetEl.classList.remove('animate-budget-update');
                    totalCostEl.classList.remove('animate-budget-update');
                }, 500);

            } else {
                const listItem = document.createElement('li');
                listItem.textContent = "ì•„ë¬´ê²ƒë„ ê³ ë¥´ì§€ ì•Šì•˜ì–´ìš”. ğŸ˜¢";
                finalCartListEl.appendChild(listItem);
            }

            let feedbackMessage = "";
            let feedbackCardClass = "";
            
            currentReflectionQuestions = [
                "í¸ì˜ì ì—ëŠ” ì‚¬ê³  ì‹¶ì€ ë¬¼ê±´ì´ ì°¸ ë§ì•˜ì£ ? ê·¸ëŸ°ë° ì™œ ëª¨ë“  ë¬¼ê±´ì„ ë‹¤ ì‚´ ìˆ˜ëŠ” ì—†ì—ˆì„ê¹Œìš”?",
                "ì‚¬ê³  ì‹¶ì€ ë¬¼ê±´ì´ ì—¬ëŸ¬ ê°œì¼ ë•Œ, ì–´ë–¤ ë¬¼ê±´ì„ ê³¨ë¼ì•¼ ê°€ì¥ ì¢‹ì„ê¹Œìš”? (ë‚˜ë§Œì˜ ì„ íƒ ê¸°ì¤€ì´ ìˆì—ˆë‚˜ìš”?)",
                "ë¬¼ê±´ì„ ì‚´ ë•Œ ì‹ ì¤‘í•˜ê²Œ ìƒê°í•˜ê³  ë˜‘ë˜‘í•˜ê²Œ ê³ ë¥´ë©´, ìš°ë¦¬ì—ê²Œ ì–´ë–¤ ì¢‹ì€ ì ì´ ìˆì„ê¹Œìš”?"
            ];

            if (cart.length === 0) { 
                feedbackTitleEl.textContent = "í…… ë¹ˆ ì¥ë°”êµ¬ë‹ˆ... ë°°ë„ í……~ ê¼¬ë¥´ë¥µ~ ğŸ¥¶";
                feedbackMessage = `<p class="font-semibold text-sky-700 mb-2">ì´ëŸ°! í¸ì˜ì ì—ì„œ ì•„ë¬´ê²ƒë„ ê³ ë¥´ì§€ ì•Šì•˜ë„¤ìš”.</p> <p>ë‹¤ì‹œ í•œë²ˆ ê³¨ë¼ë´ìš”! ì •í•´ì§„ ìš©ëˆìœ¼ë¡œ ë‚˜ë¥¼ ê°€ì¥ ê¸°ë¶„ ì¢‹ê²Œ í•  ë¬¼ê±´ë“¤ì„ ì°¾ì•„ë³´ì„¸ìš”! ğŸ›ï¸</p>`;
                feedbackCardClass = "warning-feedback";
            } else { 
                feedbackTitleEl.textContent = "ë˜‘ë˜‘í•œ ì‡¼í•‘ ì™„ë£Œ! ğŸ‰";
                feedbackMessage = `<p class="font-semibold text-green-600 mb-2">ì¢‹ì•„ìš”! ìš©ëˆ ì•ˆì—ì„œ ì›í•˜ëŠ” ë¬¼ê±´ì„ ì˜ ê³¨ëë„¤ìš”. ğŸ˜Š</p><p>ì´ì œ ë‚´ê°€ ê³ ë¥¸ ë¬¼ê±´ë“¤ì— ëŒ€í•´ ê³°ê³°ì´ ìƒê°í•´ ë³¼ê¹Œìš”?</p>`;
                feedbackCardClass = "success-feedback";
            }
            
            feedbackMessageCardEl.innerHTML = feedbackMessage;
            feedbackMessageCardEl.className = 'feedback-card-base text-lg ' + feedbackCardClass;
            reflectionAnswers = new Array(currentReflectionQuestions.length).fill(''); 
        }
        
        function loadReflectionQuestion(index) {
            currentQuestionIndex = index;
            reflectionPageTitleEl.textContent = `ë‚˜ì˜ ì‡¼í•‘, ê³°ê³°ì´ ìƒê°í•´ ë³´ê¸° (${index + 1}/${currentReflectionQuestions.length}) ğŸ§`;
            
            const questionWrapper = currentQuestionTextEl.parentNode; // This is question-content-wrapper
            const questionTextElement = questionWrapper.querySelector('p'); // The <p> inside the wrapper
            if(questionTextElement) { 
                questionTextElement.textContent = currentReflectionQuestions[index];
            }
            
            currentAnswerTextareaEl.value = reflectionAnswers[index] || ''; 
            currentAnswerTextareaEl.focus(); 

            prevQuestionButton.classList.toggle('hidden', index === 0);
            nextQuestionButton.classList.toggle('hidden', index === currentReflectionQuestions.length - 1);
            
            reflectionActionsEl.innerHTML = ''; 
            
            if (index === currentReflectionQuestions.length - 1) { 
                const saveAllButton = document.createElement('button');
                saveAllButton.id = 'save-all-answers-button';
                saveAllButton.className = 'button bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg text-lg';
                saveAllButton.textContent = 'ë‚˜ì˜ ìƒê° ëª¨ë‘ ì €ì¥í•˜ê¸° ğŸ’¾';
                saveAllButton.addEventListener('click', saveAllAnswers);
                reflectionActionsEl.appendChild(saveAllButton);

                const goToStartButton = document.createElement('button');
                goToStartButton.id = 'go-to-start-from-reflection-last'; 
                goToStartButton.className = 'button bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg text-lg';
                goToStartButton.textContent = 'ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸° ğŸ ';
                goToStartButton.addEventListener('click', startGame);
                reflectionActionsEl.appendChild(goToStartButton);
            }
        }

        function saveCurrentAnswer() {
            if (currentReflectionQuestions && currentReflectionQuestions[currentQuestionIndex] !== undefined) { 
                reflectionAnswers[currentQuestionIndex] = currentAnswerTextareaEl.value;
            }
        }
        
        function showPraiseAnimation(message) {
            praiseTextEl.textContent = message;
            praiseOverlayEl.classList.remove('hidden');
            praiseOverlayEl.classList.add('visible');

            setTimeout(() => {
                praiseOverlayEl.classList.remove('visible');
                setTimeout(() => { 
                    praiseOverlayEl.classList.add('hidden');
                    displaySavedAnswers(); 
                }, 300); 
            }, 2500); 
        }


        function saveAllAnswers() {
            saveCurrentAnswer(); 
            localStorage.setItem('shoppingReflectionAnswers', JSON.stringify(
                currentReflectionQuestions.map((q, i) => ({ question: q, answer: reflectionAnswers[i] || "" }))
            ));
            showPraiseAnimation("ë‚˜ì˜ ë©‹ì§„ ìƒê°ì´ ëª¨ë‘ ì €ì¥ë˜ì—ˆì–´ìš”! ì •ë§ í›Œë¥­í•´ìš”! ğŸ‰");
        }


        function displaySavedAnswers() {
            showScreen(screens.savedAnswers);
            const savedData = localStorage.getItem('shoppingReflectionAnswers');
            displayedAnswersEl.innerHTML = ''; 

            if (savedData) {
                const answers = JSON.parse(savedData);
                if (answers.length > 0 && answers.some(item => item.answer && item.answer.trim() !== "")) { 
                    answers.forEach((item, index) => {
                         if (item.answer && item.answer.trim() !== "") { 
                            const answerBlock = document.createElement('div');
                            answerBlock.classList.add('answer-block');
                            
                            const questionEl = document.createElement('p');
                            questionEl.classList.add('font-semibold', 'text-blue-700');
                            questionEl.textContent = `ì§ˆë¬¸ ${index + 1}: ${item.question}`;
                            
                            const answerEl = document.createElement('p');
                            answerEl.classList.add('text-gray-800', 'whitespace-pre-wrap'); 
                            answerEl.textContent = `ë‚˜ì˜ ìƒê°: ${item.answer}`;
                            
                            answerBlock.appendChild(questionEl);
                            answerBlock.appendChild(answerEl);
                            displayedAnswersEl.appendChild(answerBlock);
                        }
                    });
                    if (displayedAnswersEl.children.length === 0) {
                        displayedAnswersEl.innerHTML = '<p class="text-gray-600">ì•„ì§ ê¸°ë¡ëœ ìƒê°ì´ ì—†ì–´ìš”. ì§ˆë¬¸ì— ë‹µì„ ì‘ì„±í•˜ê³  ì €ì¥í•´ë³´ì„¸ìš”!</p>';
                    }
                } else {
                     displayedAnswersEl.innerHTML = '<p class="text-gray-600">ì•„ì§ ê¸°ë¡ëœ ìƒê°ì´ ì—†ì–´ìš”. ì§ˆë¬¸ì— ë‹µì„ ì‘ì„±í•˜ê³  ì €ì¥í•´ë³´ì„¸ìš”!</p>';
                }
            } else {
                displayedAnswersEl.innerHTML = '<p class="text-gray-600">ì €ì¥ëœ ìƒê°ì´ ì•„ì§ ì—†ì–´ìš”. ì‡¼í•‘ì„ ë§ˆì¹˜ê³  ìƒê°ì„ ê¸°ë¡í•´ë³´ì„¸ìš”!</p>';
            }
        }

        let messageTimeout; 
        function showTemporaryMessage(message, type = "info") {
            const existingMessage = document.querySelector('.temporary-message-div');
            if (existingMessage) {
                document.body.removeChild(existingMessage);
                clearTimeout(messageTimeout);
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'temporary-message-div'; 
            messageDiv.textContent = message;
            messageDiv.style.position = 'fixed';
            messageDiv.style.bottom = '20px';
            messageDiv.style.left = '50%';
            messageDiv.style.transform = 'translateX(-50%)';
            messageDiv.style.padding = '10px 20px';
            messageDiv.style.borderRadius = '8px';
            messageDiv.style.color = 'white';
            messageDiv.style.zIndex = '1000';
            messageDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            messageDiv.style.textAlign = 'center';


            if (type === "error") {
                messageDiv.style.backgroundColor = '#ef4444'; 
            } else if (type === "success") {
                messageDiv.style.backgroundColor = '#22c55e'; 
            } else { 
                messageDiv.style.backgroundColor = '#3b82f6'; 
            }
            
            document.body.appendChild(messageDiv);

            messageTimeout = setTimeout(() => {
                if (document.body.contains(messageDiv)) { 
                    document.body.removeChild(messageDiv);
                }
            }, 2500); 
        }

        checkoutButton.addEventListener('click', checkout);
        goToReflectionButton.addEventListener('click', () => {
            currentQuestionIndex = 0; 
            loadReflectionQuestion(currentQuestionIndex);
            showScreen(screens.reflection);
        });
        playAgainButtonFeedback.addEventListener('click', startGame); 
        
        prevQuestionButton.addEventListener('click', () => {
            saveCurrentAnswer();
            if (currentQuestionIndex > 0) {
                loadReflectionQuestion(currentQuestionIndex - 1);
            }
        });
        nextQuestionButton.addEventListener('click', () => {
            saveCurrentAnswer();
            if (currentQuestionIndex < currentReflectionQuestions.length - 1) {
                loadReflectionQuestion(currentQuestionIndex + 1);
            }
        });
        
        goToStartFromSaved.addEventListener('click', startGame);
        
        startGame();

    </script>
</body>
</html>
